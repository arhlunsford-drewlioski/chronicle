<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Character Sheet</title>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/sheet.css">
    <script src="js/data/spells.js"></script>
    <link rel="stylesheet" href="css/level-up.css">
</head>
<body>
    <div class="sheet">
        <h1>D&D Character Sheet</h1>

        <!-- Top Actions -->
        <div class="top-actions">
            <a href="builder.html" class="btn-builder">+ New Character</a>
            <button class="btn-export" onclick="exportCharacter()">Export JSON</button>
            <button class="btn-import" onclick="document.getElementById('import-file').click()">Import JSON</button>
            <input type="file" id="import-file" accept=".json" style="display:none" onchange="importCharacter(event)">
            <button class="btn-builder" onclick="openLevelUpModal()" style="background:linear-gradient(135deg,#1e3a8a,#1e40af);border-color:#1e3a8a">⬆ Level Up</button>
        </div>
        
        <!-- Character Info -->
        <div class="character-info">
            <div class="input-group">
                <label>Character Name</label>
                <input type="text" id="charName" placeholder="Enter name">
            </div>
            <div class="input-group">
                <label>Species</label>
                <input type="text" id="species" placeholder="e.g., Human">
            </div>
            <div class="input-group">
                <label>Class</label>
                <input type="text" id="class" placeholder="e.g., Fighter">
            </div>
            <div class="input-group">
                <label>Subclass</label>
                <input type="text" id="subclass" placeholder="e.g., Champion">
            </div>
            <div class="input-group">
                <label>Level</label>
                <input type="number" id="level" value="1" min="1" max="20">
            </div>
            <div class="input-group">
                <label>Background</label>
                <input type="text" id="background" placeholder="e.g., Soldier">
            </div>
            <div class="input-group">
                <label>Alignment</label>
                <input type="text" id="alignment" placeholder="e.g., Lawful Good">
            </div>
            <div class="input-group">
                <label>Experience Points</label>
                <input type="number" id="xp" value="0" min="0">
            </div>
        </div>

        <!-- HP Section -->
        <div style="margin-top: 20px; margin-bottom: 30px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div class="combat-box">
                    <div class="combat-label">CURRENT HP</div>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <input type="number" class="combat-value" id="current-hp" value="10" min="0" 
                               style="max-width: 80px; font-size: 20px;">
                    </div>
                    <div class="hp-control">
                        <button class="hp-button" onclick="adjustHP('current', -1)">-</button>
                        <button class="hp-button" onclick="adjustHP('current', 1)">+</button>
                    </div>
                </div>
                <div class="combat-box">
                    <div class="combat-label">MAX HP</div>
                    <div class="combat-value editable-stat" id="max-hp-display" onclick="makeStatEditable('max-hp')" style="cursor: pointer;">10</div>
                    <input type="number" id="max-hp" value="10" min="1" style="display: none;">
                </div>
                <div class="combat-box">
                    <div class="combat-label">TEMP HP</div>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <input type="number" class="combat-value" id="temp-hp" value="0" min="0" 
                               style="max-width: 80px; font-size: 20px;">
                    </div>
                    <div class="hp-control">
                        <button class="hp-button" onclick="adjustHP('temp', -1)">-</button>
                        <button class="hp-button" onclick="adjustHP('temp', 1)">+</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ability Scores with Skills -->
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-header">
                    <div class="stat-name">STRENGTH</div>
                    <div class="stat-value" onclick="makeEditable(this, 'str')" id="str-display">10</div>
                    <input type="number" id="str" value="10" min="1" max="30" style="display: none;">
                    <div class="stat-modifier-container">
                        <div class="stat-modifier-label">MODIFIER</div>
                        <div class="stat-modifier" id="str-mod">+0</div>
                    </div>
                </div>
                <div class="stat-skills">
                    <div class="stat-skill-item save-item">
                        <input type="checkbox" class="prof-checkbox" data-save="str" onchange="updateSaves()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Save</span>
                        <span class="skill-bonus" id="save-str">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="3" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Athletics</span>
                        <span class="skill-bonus" id="skill-3">+0</span>
                    </div>
                </div>
            </div>

            <div class="stat-box">
                <div class="stat-header">
                    <div class="stat-name">DEXTERITY</div>
                    <div class="stat-value" onclick="makeEditable(this, 'dex')" id="dex-display">10</div>
                    <input type="number" id="dex" value="10" min="1" max="30" style="display: none;">
                    <div class="stat-modifier-container">
                        <div class="stat-modifier-label">MODIFIER</div>
                        <div class="stat-modifier" id="dex-mod">+0</div>
                    </div>
                </div>
                <div class="stat-skills">
                    <div class="stat-skill-item save-item">
                        <input type="checkbox" class="prof-checkbox" data-save="dex" onchange="updateSaves()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Save</span>
                        <span class="skill-bonus" id="save-dex">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="0" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Acrobatics</span>
                        <span class="skill-bonus" id="skill-0">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="15" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Sleight of Hand</span>
                        <span class="skill-bonus" id="skill-15">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="16" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Stealth</span>
                        <span class="skill-bonus" id="skill-16">+0</span>
                    </div>
                </div>
            </div>

            <div class="stat-box">
                <div class="stat-header">
                    <div class="stat-name">CONSTITUTION</div>
                    <div class="stat-value" onclick="makeEditable(this, 'con')" id="con-display">10</div>
                    <input type="number" id="con" value="10" min="1" max="30" style="display: none;">
                    <div class="stat-modifier-container">
                        <div class="stat-modifier-label">MODIFIER</div>
                        <div class="stat-modifier" id="con-mod">+0</div>
                    </div>
                </div>
                <div class="stat-skills">
                    <div class="stat-skill-item save-item">
                        <input type="checkbox" class="prof-checkbox" data-save="con" onchange="updateSaves()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Save</span>
                        <span class="skill-bonus" id="save-con">+0</span>
                    </div>
                </div>
            </div>

            <div class="stat-box">
                <div class="stat-header">
                    <div class="stat-name">INTELLIGENCE</div>
                    <div class="stat-value" onclick="makeEditable(this, 'int')" id="int-display">10</div>
                    <input type="number" id="int" value="10" min="1" max="30" style="display: none;">
                    <div class="stat-modifier-container">
                        <div class="stat-modifier-label">MODIFIER</div>
                        <div class="stat-modifier" id="int-mod">+0</div>
                    </div>
                </div>
                <div class="stat-skills">
                    <div class="stat-skill-item save-item">
                        <input type="checkbox" class="prof-checkbox" data-save="int" onchange="updateSaves()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Save</span>
                        <span class="skill-bonus" id="save-int">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="2" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Arcana</span>
                        <span class="skill-bonus" id="skill-2">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="5" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">History</span>
                        <span class="skill-bonus" id="skill-5">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="8" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Investigation</span>
                        <span class="skill-bonus" id="skill-8">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="10" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Nature</span>
                        <span class="skill-bonus" id="skill-10">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="14" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Religion</span>
                        <span class="skill-bonus" id="skill-14">+0</span>
                    </div>
                </div>
            </div>

            <div class="stat-box">
                <div class="stat-header">
                    <div class="stat-name">WISDOM</div>
                    <div class="stat-value" onclick="makeEditable(this, 'wis')" id="wis-display">10</div>
                    <input type="number" id="wis" value="10" min="1" max="30" style="display: none;">
                    <div class="stat-modifier-container">
                        <div class="stat-modifier-label">MODIFIER</div>
                        <div class="stat-modifier" id="wis-mod">+0</div>
                    </div>
                </div>
                <div class="stat-skills">
                    <div class="stat-skill-item save-item">
                        <input type="checkbox" class="prof-checkbox" data-save="wis" onchange="updateSaves()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Save</span>
                        <span class="skill-bonus" id="save-wis">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="1" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Animal Handling</span>
                        <span class="skill-bonus" id="skill-1">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="6" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Insight</span>
                        <span class="skill-bonus" id="skill-6">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="9" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Medicine</span>
                        <span class="skill-bonus" id="skill-9">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="11" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Perception</span>
                        <span class="skill-bonus" id="skill-11">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="17" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Survival</span>
                        <span class="skill-bonus" id="skill-17">+0</span>
                    </div>
                </div>
            </div>

            <div class="stat-box">
                <div class="stat-header">
                    <div class="stat-name">CHARISMA</div>
                    <div class="stat-value" onclick="makeEditable(this, 'cha')" id="cha-display">10</div>
                    <input type="number" id="cha" value="10" min="1" max="30" style="display: none;">
                    <div class="stat-modifier-container">
                        <div class="stat-modifier-label">MODIFIER</div>
                        <div class="stat-modifier" id="cha-mod">+0</div>
                    </div>
                </div>
                <div class="stat-skills">
                    <div class="stat-skill-item save-item">
                        <input type="checkbox" class="prof-checkbox" data-save="cha" onchange="updateSaves()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Save</span>
                        <span class="skill-bonus" id="save-cha">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="4" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Deception</span>
                        <span class="skill-bonus" id="skill-4">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="7" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Intimidation</span>
                        <span class="skill-bonus" id="skill-7">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="12" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Performance</span>
                        <span class="skill-bonus" id="skill-12">+0</span>
                    </div>
                    <div class="stat-skill-item">
                        <input type="checkbox" class="prof-checkbox" data-skill="13" onchange="updateSkills()">
                        <span class="skill-name" style="flex: 1; margin-left: 8px;">Persuasion</span>
                        <span class="skill-bonus" id="skill-13">+0</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Combat Stats -->
        <div class="combat-section">
            <div class="combat-stats">
                <div class="combat-box">
                    <div class="combat-label">PROFICIENCY BONUS</div>
                    <div class="combat-value" id="prof-bonus">+2</div>
                </div>
                <div class="combat-box">
                    <div class="combat-label">ARMOR CLASS</div>
                    <div class="combat-value editable-stat" id="ac" onclick="makeStatEditable('ac')">10</div>
                    <input type="hidden" id="ac-override" value="">
                </div>
                <div class="combat-box">
                    <div class="combat-label">INITIATIVE</div>
                    <div class="combat-value editable-stat" id="initiative" onclick="makeStatEditable('initiative')">+0</div>
                    <input type="hidden" id="initiative-override" value="">
                </div>
                <div class="combat-box">
                    <div class="combat-label">SPEED</div>
                    <div class="combat-value editable-stat" id="speed" onclick="makeStatEditable('speed')">30</div>
                    <input type="hidden" id="speed-override" value="">
                </div>
                <div class="combat-box">
                    <div class="combat-label">SIZE</div>
                    <select id="size" style="width: 100%; padding: 8px; font-size: 16px; font-family: 'Crimson Text', Georgia, serif; font-weight: 600; text-align: center; border: 2px solid #ddd; border-radius: 4px;">
                        <option>Tiny</option>
                        <option>Small</option>
                        <option selected>Medium</option>
                        <option>Large</option>
                        <option>Huge</option>
                        <option>Gargantuan</option>
                    </select>
                </div>
                <div class="combat-box">
                    <div class="combat-label">PASSIVE PERCEPTION</div>
                    <div class="combat-value editable-stat" id="passive-perception" onclick="makeStatEditable('passive-perception')">10</div>
                    <input type="hidden" id="passive-perception-override" value="">
                </div>
            </div>

            <!-- Hit Dice & Death Saves -->
            <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                <!-- Hit Dice -->
                <div class="combat-box">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <div class="combat-label">HIT DICE TYPE</div>
                        <input type="text" id="hit-dice-type" value="1d8" style="width: 80px; padding: 6px; text-align: center; border: 2px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                        <button onclick="spendHitDice()" style="padding: 8px 16px; background: #5a1a1a; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Cinzel', serif; font-weight: 600;">Spend</button>
                        <div style="font-size: 24px; font-weight: bold; font-family: 'Crimson Text', Georgia, serif;">
                            <span id="current-hit-dice">1</span> / <span id="max-hit-dice">1</span>
                        </div>
                        <button onclick="restoreHitDice()" style="padding: 8px 16px; background: #2d5016; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Cinzel', serif; font-weight: 600;">Restore</button>
                    </div>
                </div>

                <!-- Death Saves -->
                <div class="combat-box">
                    <div class="combat-label" style="margin-bottom: 15px;">DEATH SAVES</div>
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #2d5016; font-family: 'Cinzel', serif; font-size: 12px;">SUCCESSES</div>
                        <div style="display: flex; gap: 15px; justify-content: center; align-items: center;">
                            <input type="checkbox" class="death-save-checkbox" data-type="success" data-index="0">
                            <input type="checkbox" class="death-save-checkbox" data-type="success" data-index="1">
                            <input type="checkbox" class="death-save-checkbox" data-type="success" data-index="2">
                        </div>
                    </div>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 8px; color: #5a1a1a; font-family: 'Cinzel', serif; font-size: 12px;">FAILURES</div>
                        <div style="display: flex; gap: 15px; justify-content: center; align-items: center;">
                            <input type="checkbox" class="death-save-checkbox" data-type="failure" data-index="0">
                            <input type="checkbox" class="death-save-checkbox" data-type="failure" data-index="1">
                            <input type="checkbox" class="death-save-checkbox" data-type="failure" data-index="2">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inspiration & Exhaustion -->
            <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="combat-box" style="padding: 15px;">
                    <div class="combat-label" style="margin-bottom: 10px;">HEROIC INSPIRATION</div>
                    <div style="text-align: center;">
                        <button id="inspiration-toggle" onclick="toggleInspiration()" 
                                style="background: linear-gradient(135deg, #e0e0e0 0%, #d0d0d0 100%); border: 2px solid #8B4513; border-radius: 20px; padding: 8px 20px; font-family: 'Cinzel', serif; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            NOT INSPIRED
                        </button>
                        <input type="checkbox" id="inspiration" style="display: none;">
                    </div>
                </div>
                <div class="combat-box">
                    <div class="combat-label">EXHAUSTION LEVEL</div>
                    <div class="exhaustion-slider">
                        <div class="exhaustion-track" id="exhaustion-track">
                            <div class="exhaustion-box" onclick="toggleExhaustion(1)"></div>
                            <div class="exhaustion-box" onclick="toggleExhaustion(2)"></div>
                            <div class="exhaustion-box" onclick="toggleExhaustion(3)"></div>
                            <div class="exhaustion-box" onclick="toggleExhaustion(4)"></div>
                            <div class="exhaustion-box" onclick="toggleExhaustion(5)"></div>
                            <div class="exhaustion-box" onclick="toggleExhaustion(6)"></div>
                            <div class="exhaustion-box" onclick="toggleExhaustion(7)"></div>
                            <div class="exhaustion-box" onclick="toggleExhaustion(8)"></div>
                            <div class="exhaustion-box" onclick="toggleExhaustion(9)"></div>
                            <div class="exhaustion-box" onclick="toggleExhaustion(10)"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 10px; color: #666; font-weight: 600; margin-top: 5px;">
                            <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
                        </div>
                        <div style="text-align: center; margin-top: 8px;">
                            <span style="font-weight: 700; color: #8B4513; font-size: 14px;">Level: <span id="exhaustion-level">None</span></span>
                            <span style="font-size: 11px; color: #666; margin-left: 10px;">(10 = Death)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rest & Recovery -->
        <div style="margin-top: 30px;">
            <div class="section-title">Rest & Recovery</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <button onclick="shortRest()" style="padding: 15px; background: linear-gradient(135deg, #4a7c59 0%, #2d5016 100%); color: #faf7f2; border: 2px solid #2d5016; border-radius: 8px; font-family: 'Cinzel', serif; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.2); transition: all 0.2s;">SHORT REST</button>
                <button onclick="longRest()" style="padding: 15px; background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: #faf7f2; border: 2px solid #1e3a8a; border-radius: 8px; font-family: 'Cinzel', serif; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.2); transition: all 0.2s;">LONG REST</button>
            </div>
        </div>

        <!-- Spells & Magic Section -->
        <div class="collapsible-section" id="spells-section" style="margin-top: 30px; display: none;">
            <div class="section-title section-toggle" onclick="toggleSection('spells')">
                <span class="toggle-icon" id="spells-icon">▼</span> Spells & Magic
            </div>
            <div class="section-body" id="spells-body">
                <!-- Spell Slots -->
                <div style="margin-bottom: 20px;">
                    <h3 style="font-family: var(--font-heading); font-size: 16px; color: var(--brown-dark); margin-bottom: 12px;">Spell Slots</h3>
                    <div class="spell-slots-grid" id="spell-slots-container"></div>
                </div>
                
                <!-- Spellbook -->
                <div>
                    <h3 style="font-family: var(--font-heading); font-size: 16px; color: var(--brown-dark); margin-bottom: 12px;">Spellbook</h3>
                    
                    <!-- Search & Filters -->
                    <div style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="spell-search" placeholder="Search spells..." style="padding: 8px 12px; border: 2px solid var(--brown-light); border-radius: 4px; font-size: 14px;">
                        <select id="spell-level-filter" style="padding: 8px 12px; border: 2px solid var(--brown-light); border-radius: 4px; font-size: 14px;">
                            <option value="">All Levels</option>
                            <option value="0">Cantrips</option>
                            <option value="1">1st Level</option>
                            <option value="2">2nd Level</option>
                            <option value="3">3rd Level</option>
                            <option value="4">4th Level</option>
                            <option value="5">5th Level</option>
                            <option value="6">6th Level</option>
                            <option value="7">7th Level</option>
                            <option value="8">8th Level</option>
                            <option value="9">9th Level</option>
                        </select>
                        <select id="spell-school-filter" style="padding: 8px 12px; border: 2px solid var(--brown-light); border-radius: 4px; font-size: 14px;">
                            <option value="">All Schools</option>
                            <option value="Abjuration">Abjuration</option>
                            <option value="Conjuration">Conjuration</option>
                            <option value="Divination">Divination</option>
                            <option value="Enchantment">Enchantment</option>
                            <option value="Evocation">Evocation</option>
                            <option value="Illusion">Illusion</option>
                            <option value="Necromancy">Necromancy</option>
                            <option value="Transmutation">Transmutation</option>
                        </select>
                        <button onclick="openSpellBrowser()" style="padding: 8px 16px; background: linear-gradient(135deg, var(--green-primary), var(--green-dark)); color: var(--parchment-light); border: 2px solid var(--green-dark); border-radius: 4px; font-family: var(--font-heading); font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap;">+ Add Spell</button>
                    </div>
                    
                    <!-- Spell List -->
                    <div id="spellbook-container"></div>
                </div>
            </div>
        </div>

        <!-- Conditions -->
        <div class="collapsible-section" style="margin-top: 30px;">
            <div class="section-title section-toggle" onclick="toggleSection('conditions')">
                <span class="toggle-icon" id="conditions-icon">▼</span> Conditions
            </div>
            <div class="section-body" id="conditions-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: linear-gradient(135deg, #fff9f0 0%, #f5ede0 100%); border: 2px solid #8B4513; border-radius: 4px; cursor: pointer;"><input type="checkbox" class="condition-check" data-condition="blinded"><span style="font-size: 14px;">Blinded</span></label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: linear-gradient(135deg, #fff9f0 0%, #f5ede0 100%); border: 2px solid #8B4513; border-radius: 4px; cursor: pointer;"><input type="checkbox" class="condition-check" data-condition="charmed"><span style="font-size: 14px;">Charmed</span></label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: linear-gradient(135deg, #fff9f0 0%, #f5ede0 100%); border: 2px solid #8B4513; border-radius: 4px; cursor: pointer;"><input type="checkbox" class="condition-check" data-condition="deafened"><span style="font-size: 14px;">Deafened</span></label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: linear-gradient(135deg, #fff9f0 0%, #f5ede0 100%); border: 2px solid #8B4513; border-radius: 4px; cursor: pointer;"><input type="checkbox" class="condition-check" data-condition="frightened"><span style="font-size: 14px;">Frightened</span></label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: linear-gradient(135deg, #fff9f0 0%, #f5ede0 100%); border: 2px solid #8B4513; border-radius: 4px; cursor: pointer;"><input type="checkbox" class="condition-check" data-condition="grappled"><span style="font-size: 14px;">Grappled</span></label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: linear-gradient(135deg, #fff9f0 0%, #f5ede0 100%); border: 2px solid #8B4513; border-radius: 4px; cursor: pointer;"><input type="checkbox" class="condition-check" data-condition="incapacitated"><span style="font-size: 14px;">Incapacitated</span></label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: linear-gradient(135deg, #fff9f0 0%, #f5ede0 100%); border: 2px solid #8B4513; border-radius: 4px; cursor: pointer;"><input type="checkbox" class="condition-check" data-condition="invisible"><span style="font-size: 14px;">Invisible</span></label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: linear-gradient(135deg, #fff9f0 0%, #f5ede0 100%); border: 2px solid #8B4513; border-radius: 4px; cursor: pointer;"><input type="checkbox" class="condition-check" data-condition="paralyzed"><span style="font-size: 14px;">Paralyzed</span></label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: linear-gradient(135deg, #fff9f0 0%, #f5ede0 100%); border: 2px solid #8B4513; border-radius: 4px; cursor: pointer;"><input type="checkbox" class="condition-check" data-condition="petrified"><span style="font-size: 14px;">Petrified</span></label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: linear-gradient(135deg, #fff9f0 0%, #f5ede0 100%); border: 2px solid #8B4513; border-radius: 4px; cursor: pointer;"><input type="checkbox" class="condition-check" data-condition="poisoned"><span style="font-size: 14px;">Poisoned</span></label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: linear-gradient(135deg, #fff9f0 0%, #f5ede0 100%); border: 2px solid #8B4513; border-radius: 4px; cursor: pointer;"><input type="checkbox" class="condition-check" data-condition="prone"><span style="font-size: 14px;">Prone</span></label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: linear-gradient(135deg, #fff9f0 0%, #f5ede0 100%); border: 2px solid #8B4513; border-radius: 4px; cursor: pointer;"><input type="checkbox" class="condition-check" data-condition="restrained"><span style="font-size: 14px;">Restrained</span></label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: linear-gradient(135deg, #fff9f0 0%, #f5ede0 100%); border: 2px solid #8B4513; border-radius: 4px; cursor: pointer;"><input type="checkbox" class="condition-check" data-condition="stunned"><span style="font-size: 14px;">Stunned</span></label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: linear-gradient(135deg, #fff9f0 0%, #f5ede0 100%); border: 2px solid #8B4513; border-radius: 4px; cursor: pointer;"><input type="checkbox" class="condition-check" data-condition="unconscious"><span style="font-size: 14px;">Unconscious</span></label>
                </div>
            </div>
        </div>

        <!-- Proficiencies & Training -->
        <div class="collapsible-section" style="margin-top: 30px;">
            <div class="section-title section-toggle" onclick="toggleSection('proficiencies')">
                <span class="toggle-icon" id="proficiencies-icon">▼</span>
                Equipment Training & Proficiencies
            </div>
            <div class="section-body" id="proficiencies-body">
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #5a1a1a; font-family: 'Cinzel', serif;">Armor</div>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" id="prof-light-armor"><span>Light Armor</span></label>
                        <label style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" id="prof-medium-armor"><span>Medium Armor</span></label>
                        <label style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" id="prof-heavy-armor"><span>Heavy Armor</span></label>
                        <label style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" id="prof-shields"><span>Shields</span></label>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #5a1a1a; font-family: 'Cinzel', serif;">Weapons</div>
                    <textarea id="weapon-profs" placeholder="e.g., Simple weapons, Martial weapons, Longsword, Rapier..." style="width: 100%; min-height: 60px; padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-family: 'Crimson Text', Georgia, serif; font-size: 14px;"></textarea>
                </div>
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #5a1a1a; font-family: 'Cinzel', serif;">Tools</div>
                    <textarea id="tool-profs" placeholder="e.g., Thieves' tools, Smith's tools, Disguise kit..." style="width: 100%; min-height: 60px; padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-family: 'Crimson Text', Georgia, serif; font-size: 14px;"></textarea>
                </div>
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #5a1a1a; font-family: 'Cinzel', serif;">Languages</div>
                    <textarea id="languages" placeholder="e.g., Common, Elvish, Dwarvish, Draconic..." style="width: 100%; min-height: 60px; padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-family: 'Crimson Text', Georgia, serif; font-size: 14px;"></textarea>
                </div>
            </div>
        </div>
        <!-- Coins -->
        <div class="collapsible-section" style="margin-top: 30px;">
            <div class="section-title section-toggle" onclick="toggleSection('coins')">
                <span class="toggle-icon" id="coins-icon">▼</span> Coins
            </div>
            <div class="section-body" id="coins-body">
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                    <div class="combat-box" style="padding: 10px;"><div style="font-size: 11px; font-weight: 600; margin-bottom: 5px; color: #8B4513;">CP</div><input type="number" id="coin-cp" value="0" min="0" style="width: 100%; padding: 5px; text-align: center; border: 2px solid #c9a77c; border-radius: 4px;"></div>
                    <div class="combat-box" style="padding: 10px;"><div style="font-size: 11px; font-weight: 600; margin-bottom: 5px; color: #8B4513;">SP</div><input type="number" id="coin-sp" value="0" min="0" style="width: 100%; padding: 5px; text-align: center; border: 2px solid #c9a77c; border-radius: 4px;"></div>
                    <div class="combat-box" style="padding: 10px;"><div style="font-size: 11px; font-weight: 600; margin-bottom: 5px; color: #8B4513;">EP</div><input type="number" id="coin-ep" value="0" min="0" style="width: 100%; padding: 5px; text-align: center; border: 2px solid #c9a77c; border-radius: 4px;"></div>
                    <div class="combat-box" style="padding: 10px;"><div style="font-size: 11px; font-weight: 600; margin-bottom: 5px; color: #8B4513;">GP</div><input type="number" id="coin-gp" value="0" min="0" style="width: 100%; padding: 5px; text-align: center; border: 2px solid #c9a77c; border-radius: 4px;"></div>
                    <div class="combat-box" style="padding: 10px;"><div style="font-size: 11px; font-weight: 600; margin-bottom: 5px; color: #8B4513;">PP</div><input type="number" id="coin-pp" value="0" min="0" style="width: 100%; padding: 5px; text-align: center; border: 2px solid #c9a77c; border-radius: 4px;"></div>
                </div>
            </div>
        </div>

        <!-- Notes & Features -->
        <div class="collapsible-section" style="margin-top: 30px;">
            <div class="section-title section-toggle" onclick="toggleSection('notes')">
                <span class="toggle-icon" id="notes-icon">▼</span> Notes & Features
            </div>
            <div class="section-body" id="notes-body">
                <textarea id="notes" placeholder="Racial traits, class features, important notes..." style="width: 100%; min-height: 150px; padding: 15px; border: 2px solid #8B4513; border-radius: 8px; font-family: 'Crimson Text', Georgia, serif; font-size: 14px; background: linear-gradient(135deg, #fff9f0 0%, #f5ede0 100%); resize: vertical;"></textarea>
            </div>
        </div>

        <button class="save-button" onclick="saveCharacter()">Save Character</button>
    </div>

    <!-- Spell Browser Modal -->
    <div id="spell-browser-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; padding: 20px; overflow-y: auto;">
        <div style="max-width: 900px; margin: 40px auto; background: linear-gradient(to bottom, var(--parchment-light), var(--parchment-mid)); border: 3px solid var(--brown-primary); border-radius: 12px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
            
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--brown-primary);">
                <h2 style="font-family: var(--font-heading); font-size: 24px; color: var(--brown-dark); margin: 0;">Add Spells to Spellbook</h2>
                <button onclick="closeSpellBrowser()" style="background: none; border: none; font-size: 28px; color: var(--brown-dark); cursor: pointer; line-height: 1;">&times;</button>
            </div>

            <!-- Class Filter -->
            <div style="margin-bottom: 15px;">
                <label style="font-family: var(--font-heading); font-size: 12px; color: var(--brown-dark); font-weight: 600; margin-bottom: 6px; display: block;">FILTER BY CLASS</label>
                <select id="modal-class-filter" onchange="filterModalSpells()" style="width: 100%; padding: 10px; border: 2px solid var(--brown-light); border-radius: 4px; font-size: 14px;">
                    <option value="">All Classes</option>
                    <option value="Bard">Bard</option>
                    <option value="Cleric">Cleric</option>
                    <option value="Druid">Druid</option>
                    <option value="Paladin">Paladin</option>
                    <option value="Ranger">Ranger</option>
                    <option value="Sorcerer">Sorcerer</option>
                    <option value="Warlock">Warlock</option>
                    <option value="Wizard">Wizard</option>
                </select>
            </div>

            <!-- Search & Filters -->
            <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="modal-spell-search" placeholder="Search spells..." oninput="filterModalSpells()" style="padding: 10px; border: 2px solid var(--brown-light); border-radius: 4px; font-size: 14px;">
                <select id="modal-level-filter" onchange="filterModalSpells()" style="padding: 10px; border: 2px solid var(--brown-light); border-radius: 4px; font-size: 14px;">
                    <option value="">All Levels</option>
                    <option value="0">Cantrips</option>
                    <option value="1">1st Level</option>
                    <option value="2">2nd Level</option>
                    <option value="3">3rd Level</option>
                    <option value="4">4th Level</option>
                    <option value="5">5th Level</option>
                    <option value="6">6th Level</option>
                    <option value="7">7th Level</option>
                    <option value="8">8th Level</option>
                    <option value="9">9th Level</option>
                </select>
                <select id="modal-school-filter" onchange="filterModalSpells()" style="padding: 10px; border: 2px solid var(--brown-light); border-radius: 4px; font-size: 14px;">
                    <option value="">All Schools</option>
                    <option value="Abjuration">Abjuration</option>
                    <option value="Conjuration">Conjuration</option>
                    <option value="Divination">Divination</option>
                    <option value="Enchantment">Enchantment</option>
                    <option value="Evocation">Evocation</option>
                    <option value="Illusion">Illusion</option>
                    <option value="Necromancy">Necromancy</option>
                    <option value="Transmutation">Transmutation</option>
                </select>
            </div>

            <!-- Spell Browser List -->
            <div id="modal-spell-list" style="max-height: 500px; overflow-y: auto; border: 2px solid var(--brown-light); border-radius: 8px; padding: 15px; background: rgba(255,255,255,0.3);"></div>

            <!-- Footer -->
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="closeSpellBrowser()" style="padding: 12px 24px; background: linear-gradient(135deg, var(--brown-primary), var(--brown-darker)); color: var(--parchment-light); border: 2px solid var(--brown-dark); border-radius: 6px; font-family: var(--font-heading); font-size: 14px; font-weight: 600; cursor: pointer;">Done</button>
            </div>
        </div>
    </div>

    <script>
        const skills = [
            { name: 'Acrobatics', ability: 'dex' },
            { name: 'Animal Handling', ability: 'wis' },
            { name: 'Arcana', ability: 'int' },
            { name: 'Athletics', ability: 'str' },
            { name: 'Deception', ability: 'cha' },
            { name: 'History', ability: 'int' },
            { name: 'Insight', ability: 'wis' },
            { name: 'Intimidation', ability: 'cha' },
            { name: 'Investigation', ability: 'int' },
            { name: 'Medicine', ability: 'wis' },
            { name: 'Nature', ability: 'int' },
            { name: 'Perception', ability: 'wis' },
            { name: 'Performance', ability: 'cha' },
            { name: 'Persuasion', ability: 'cha' },
            { name: 'Religion', ability: 'int' },
            { name: 'Sleight of Hand', ability: 'dex' },
            { name: 'Stealth', ability: 'dex' },
            { name: 'Survival', ability: 'wis' }
        ];

        let currentExhaustion = 0;

        // ═══════════════════════════════════════════════════════════════════
        //  SPELL SYSTEM STATE & DATA
        // ═══════════════════════════════════════════════════════════════════
        
        window.currentSpells = {
            knownSpells: [],
            preparedSpells: [],
            spellSlots: {
                1: { current: 0, max: 0 },
                2: { current: 0, max: 0 },
                3: { current: 0, max: 0 },
                4: { current: 0, max: 0 },
                5: { current: 0, max: 0 },
                6: { current: 0, max: 0 },
                7: { current: 0, max: 0 },
                8: { current: 0, max: 0 },
                9: { current: 0, max: 0 }
            }
        };

        // Spell slot progression tables
        const SPELL_SLOTS = {
            // Full casters: Bard, Cleric, Druid, Sorcerer, Wizard
            full: {
                1: [2,0,0,0,0,0,0,0,0],
                2: [3,0,0,0,0,0,0,0,0],
                3: [4,2,0,0,0,0,0,0,0],
                4: [4,3,0,0,0,0,0,0,0],
                5: [4,3,2,0,0,0,0,0,0],
                6: [4,3,3,0,0,0,0,0,0],
                7: [4,3,3,1,0,0,0,0,0],
                8: [4,3,3,2,0,0,0,0,0],
                9: [4,3,3,3,1,0,0,0,0],
                10: [4,3,3,3,2,0,0,0,0],
                11: [4,3,3,3,2,1,0,0,0],
                12: [4,3,3,3,2,1,0,0,0],
                13: [4,3,3,3,2,1,1,0,0],
                14: [4,3,3,3,2,1,1,0,0],
                15: [4,3,3,3,2,1,1,1,0],
                16: [4,3,3,3,2,1,1,1,0],
                17: [4,3,3,3,2,1,1,1,1],
                18: [4,3,3,3,3,1,1,1,1],
                19: [4,3,3,3,3,2,1,1,1],
                20: [4,3,3,3,3,2,2,1,1]
            },
            // Half casters: Paladin, Ranger (start at 2, max 5th level slots)
            half: {
                1: [0,0,0,0,0,0,0,0,0],
                2: [2,0,0,0,0,0,0,0,0],
                3: [3,0,0,0,0,0,0,0,0],
                4: [3,0,0,0,0,0,0,0,0],
                5: [4,2,0,0,0,0,0,0,0],
                6: [4,2,0,0,0,0,0,0,0],
                7: [4,3,0,0,0,0,0,0,0],
                8: [4,3,0,0,0,0,0,0,0],
                9: [4,3,2,0,0,0,0,0,0],
                10: [4,3,2,0,0,0,0,0,0],
                11: [4,3,3,0,0,0,0,0,0],
                12: [4,3,3,0,0,0,0,0,0],
                13: [4,3,3,1,0,0,0,0,0],
                14: [4,3,3,1,0,0,0,0,0],
                15: [4,3,3,2,0,0,0,0,0],
                16: [4,3,3,2,0,0,0,0,0],
                17: [4,3,3,3,1,0,0,0,0],
                18: [4,3,3,3,1,0,0,0,0],
                19: [4,3,3,3,2,0,0,0,0],
                20: [4,3,3,3,2,0,0,0,0]
            },
            // Warlock - Pact Magic (all slots same level, restore on short rest)
            warlock: {
                1: [1,0,0,0,0,0,0,0,0],
                2: [2,0,0,0,0,0,0,0,0],
                3: [0,2,0,0,0,0,0,0,0],
                4: [0,2,0,0,0,0,0,0,0],
                5: [0,0,2,0,0,0,0,0,0],
                6: [0,0,2,0,0,0,0,0,0],
                7: [0,0,0,2,0,0,0,0,0],
                8: [0,0,0,2,0,0,0,0,0],
                9: [0,0,0,0,2,0,0,0,0],
                10: [0,0,0,0,2,0,0,0,0],
                11: [0,0,0,0,0,3,0,0,0],
                12: [0,0,0,0,0,3,0,0,0],
                13: [0,0,0,0,0,3,0,0,0],
                14: [0,0,0,0,0,3,0,0,0],
                15: [0,0,0,0,0,3,0,0,0],
                16: [0,0,0,0,0,3,0,0,0],
                17: [0,0,0,0,0,0,4,0,0],
                18: [0,0,0,0,0,0,4,0,0],
                19: [0,0,0,0,0,0,4,0,0],
                20: [0,0,0,0,0,0,4,0,0]
            }
        };

        // ═══════════════════════════════════════════════════════════════════
        //  SPELL SLOT FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        function updateSpellSlots() {
            const className = (document.getElementById('class').value || '').toLowerCase();
            const level = parseInt(document.getElementById('level').value) || 1;
            
            // Determine caster type
            let casterType = null;
            if (['bard', 'cleric', 'druid', 'sorcerer', 'wizard'].includes(className)) {
                casterType = 'full';
            } else if (['paladin', 'ranger'].includes(className)) {
                casterType = 'half';
            } else if (className === 'warlock') {
                casterType = 'warlock';
            }
            
            // Show/hide spell section
            const spellSection = document.getElementById('spells-section');
            if (casterType) {
                spellSection.style.display = '';
                
                // Get slot progression for this class/level
                const slots = SPELL_SLOTS[casterType][level] || [0,0,0,0,0,0,0,0,0];
                
                // Update spell slot maxes
                for (let i = 1; i <= 9; i++) {
                    const max = slots[i - 1];
                    window.currentSpells.spellSlots[i].max = max;
                    
                    // Don't reset current if we already have slots (preserve usage)
                    if (window.currentSpells.spellSlots[i].current > max) {
                        window.currentSpells.spellSlots[i].current = max;
                    }
                }
                
                renderSpellSlots();
                loadSpellbook();
            } else {
                spellSection.style.display = 'none';
            }
        }

        function renderSpellSlots() {
            const container = document.getElementById('spell-slots-container');
            if (!container) return;
            
            let html = '';
            
            for (let level = 1; level <= 9; level++) {
                const slot = window.currentSpells.spellSlots[level];
                if (slot.max === 0) continue; // Skip levels with no slots
                
                html += `
                    <div class="spell-slot-level">
                        <div class="spell-slot-label">Level ${level}</div>
                        <div class="spell-slot-circles">
                            ${Array.from({length: slot.max}, (_, i) => `
                                <div class="spell-slot-circle ${i < slot.current ? 'filled' : ''}" 
                                     onclick="toggleSpellSlot(${level}, ${i})"
                                     data-level="${level}" data-index="${i}">
                                </div>
                            `).join('')}
                        </div>
                        <div class="spell-slot-count">${slot.current}/${slot.max}</div>
                    </div>
                `;
            }
            
            container.innerHTML = html || '<p style="color: #999; font-style: italic;">No spell slots available at this level.</p>';
        }

        function toggleSpellSlot(level, index) {
            const slot = window.currentSpells.spellSlots[level];
            
            // If clicking a filled circle, empty it and all after it
            if (index < slot.current) {
                slot.current = index;
            }
            // If clicking first empty circle, fill up to and including it
            else if (index === slot.current) {
                slot.current = index + 1;
            }
            
            renderSpellSlots();
        }

        // ═══════════════════════════════════════════════════════════════════
        //  SPELLBOOK FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        function loadSpellbook() {
            // This will be called when class/level changes
            // For now, just render what we have
            renderSpellbook();
        }

        function renderSpellbook() {
            const container = document.getElementById('spellbook-container');
            if (!container) return;
            
            // Get filter values
            const searchTerm = (document.getElementById('spell-search')?.value || '').toLowerCase();
            const levelFilter = document.getElementById('spell-level-filter')?.value || '';
            const schoolFilter = document.getElementById('spell-school-filter')?.value || '';
            
            // Filter spells
            let spellsToShow = window.currentSpells.knownSpells;
            
            if (searchTerm) {
                spellsToShow = spellsToShow.filter(spell => 
                    spell.name.toLowerCase().includes(searchTerm) ||
                    (spell.description || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (levelFilter !== '') {
                spellsToShow = spellsToShow.filter(spell => spell.level === parseInt(levelFilter));
            }
            
            if (schoolFilter) {
                spellsToShow = spellsToShow.filter(spell => spell.school === schoolFilter);
            }
            
            // Group by level
            const byLevel = {};
            for (let i = 0; i <= 9; i++) byLevel[i] = [];
            
            spellsToShow.forEach(spell => {
                if (spell.level >= 0 && spell.level <= 9) {
                    byLevel[spell.level].push(spell);
                }
            });
            
            // Render
            let html = '';
            
            for (let level = 0; level <= 9; level++) {
                const spells = byLevel[level];
                if (spells.length === 0) continue;
                
                const levelName = level === 0 ? 'Cantrips' : `Level ${level}`;
                
                html += `<div class="spell-level-group">
                    <h4>${levelName}</h4>
                    <div class="spell-list">`;
                
                spells.forEach(spell => {
                    const isPrepared = window.currentSpells.preparedSpells.includes(spell.name);
                    const isCantrip = spell.level === 0;
                    const desc = spell.description || spell.desc || '';
                    
                    html += `
                        <div class="spell-card ${isPrepared ? 'prepared' : ''}" data-spell="${spell.name}">
                            <div class="spell-card-header">
                                ${!isCantrip ? `<input type="checkbox" class="spell-prepare-check" 
                                    ${isPrepared ? 'checked' : ''} 
                                    onclick="event.stopPropagation(); togglePrepared('${spell.name.replace(/'/g, "\\\'")}')" />` : ''}
                                <div class="spell-card-title" onclick="toggleSpellDetails('${spell.name.replace(/'/g, "\\\'")}')" style="cursor: pointer; flex: 1;">${spell.name}</div>
                                <div class="spell-card-school">${spell.school}</div>
                                <button onclick="removeSpellFromSpellbook('${spell.name.replace(/'/g, "\\\'")}')" style="background: none; border: none; color: #999; cursor: pointer; font-size: 18px; padding: 0 6px; margin-left: 8px;" title="Remove spell">×</button>
                            </div>
                            <div class="spell-card-details" style="display: none;">
                                <div class="spell-meta">
                                    <span><strong>Casting Time:</strong> ${spell.castingTime}</span>
                                    <span><strong>Range:</strong> ${spell.range}</span>
                                    <span><strong>Components:</strong> ${spell.components}</span>
                                    <span><strong>Duration:</strong> ${spell.duration}</span>
                                </div>
                                <div class="spell-description">${desc}</div>
                                <div style="margin-top: 8px; font-size: 11px; color: var(--brown-primary); font-weight: 600;">${spell.source || ''}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            if (!html) {
                html = '<p style="color: #999; font-style: italic; text-align: center; padding: 20px;">No spells found. Add spells to your spellbook!</p>';
            }
            
            container.innerHTML = html;
        }

        function toggleSpellDetails(spellName) {
            const card = document.querySelector(`.spell-card[data-spell="${spellName}"]`);
            if (!card) return;
            
            const details = card.querySelector('.spell-card-details');
            if (details) {
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
            }
        }

        function togglePrepared(spellName) {
            const index = window.currentSpells.preparedSpells.indexOf(spellName);
            
            if (index > -1) {
                window.currentSpells.preparedSpells.splice(index, 1);
            } else {
                window.currentSpells.preparedSpells.push(spellName);
            }
            
            renderSpellbook();
        }

        // Add event listeners for spell filters
        document.addEventListener('DOMContentLoaded', () => {
            const spellSearch = document.getElementById('spell-search');
            const levelFilter = document.getElementById('spell-level-filter');
            const schoolFilter = document.getElementById('spell-school-filter');
            
            if (spellSearch) spellSearch.addEventListener('input', renderSpellbook);
            if (levelFilter) levelFilter.addEventListener('change', renderSpellbook);
            if (schoolFilter) schoolFilter.addEventListener('change', renderSpellbook);
        });

        // ═══════════════════════════════════════════════════════════════════
        //  END SPELL SYSTEM
        // ═══════════════════════════════════════════════════════════════════

        function toggleInspiration() {
            const checkbox = document.getElementById('inspiration');
            const button = document.getElementById('inspiration-toggle');
            checkbox.checked = !checkbox.checked;
            if (checkbox.checked) {
                button.textContent = 'INSPIRED';
                button.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
                button.style.color = '#5a1a1a';
                button.style.boxShadow = '0 3px 8px rgba(255, 215, 0, 0.5), 0 0 15px rgba(255, 215, 0, 0.3)';
            } else {
                button.textContent = 'NOT INSPIRED';
                button.style.background = 'linear-gradient(135deg, #e0e0e0 0%, #d0d0d0 100%)';
                button.style.color = '#333';
                button.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
            }
        }

        function toggleExhaustion(level) {
            if (currentExhaustion === level) { currentExhaustion = 0; document.getElementById('exhaustion-level').textContent = 'None'; }
            else { currentExhaustion = level; document.getElementById('exhaustion-level').textContent = level; }
            const boxes = document.querySelectorAll('.exhaustion-box');
            boxes.forEach((box, index) => { box.classList.toggle('filled', index < currentExhaustion); });
        }

        function shortRest() {
            if (confirm('Take a short rest? This will allow you to spend hit dice to recover HP.')) {
                // Restore Warlock spell slots on short rest
                const className = (document.getElementById('class').value || '').toLowerCase();
                if (className === 'warlock') {
                    for (let level = 1; level <= 9; level++) {
                        window.currentSpells.spellSlots[level].current = window.currentSpells.spellSlots[level].max;
                    }
                    renderSpellSlots();
                }
                
                alert('Short Rest: You can now spend hit dice using the buttons above. Remember to restore any class features that recharge on a short rest!');
            }
        }

        function longRest() {
            if (confirm('Take a long rest? This will restore HP, half your hit dice, and reset abilities.')) {
                const maxHP = parseInt(document.getElementById('max-hp').value) || 10;
                document.getElementById('current-hp').value = maxHP;
                const maxHitDice = parseInt(document.getElementById('max-hit-dice').textContent) || 1;
                const restoreAmount = Math.max(1, Math.floor(maxHitDice / 2));
                const currentHitDice = parseInt(document.getElementById('current-hit-dice').textContent) || 0;
                document.getElementById('current-hit-dice').textContent = Math.min(maxHitDice, currentHitDice + restoreAmount);
                document.getElementById('temp-hp').value = 0;
                document.querySelectorAll('.death-save-checkbox').forEach(cb => cb.checked = false);
                if (currentExhaustion > 0) toggleExhaustion(currentExhaustion - 1);
                
                // Restore all spell slots on long rest
                for (let level = 1; level <= 9; level++) {
                    window.currentSpells.spellSlots[level].current = window.currentSpells.spellSlots[level].max;
                }
                renderSpellSlots();
                
                alert('Long Rest complete! HP, hit dice, and spell slots restored. Remember to reset daily abilities!');
            }
        }

        function toggleSection(sectionId) {
            document.getElementById(`${sectionId}-body`).classList.toggle('collapsed');
            document.getElementById(`${sectionId}-icon`).classList.toggle('collapsed');
        }

        function adjustHP(type, amount) {
            const input = document.getElementById(type === 'current' ? 'current-hp' : 'temp-hp');
            let value = Math.max(0, (parseInt(input.value) || 0) + amount);
            if (type === 'current') value = Math.min(value, parseInt(document.getElementById('max-hp').value) || 10);
            input.value = value;
        }

        function makeStatEditable(statId) {
            const displayElement = document.getElementById(statId === 'max-hp' ? 'max-hp-display' : statId);
            const isMaxHP = statId === 'max-hp';
            const currentValue = isMaxHP ? document.getElementById('max-hp').value : (document.getElementById(`${statId}-override`).value || displayElement.textContent);
            const inputType = isMaxHP ? 'number' : 'text';
            displayElement.innerHTML = `<input type="${inputType}" value="${currentValue}" ${isMaxHP?'min="1"':''} style="width: 80px; border: none; text-align: center; font-size: 24px; font-weight: bold; background: transparent; outline: none;" onblur="finishStatEdit('${statId}')" onkeypress="if(event.key==='Enter') this.blur();" id="${statId}-temp">`;
            const tempInput = document.getElementById(`${statId}-temp`);
            tempInput.focus(); tempInput.select();
        }

        function finishStatEdit(statId) {
            const tempInput = document.getElementById(`${statId}-temp`);
            const newValue = tempInput.value.trim();
            if (statId === 'max-hp') {
                document.getElementById('max-hp').value = newValue || 10;
                document.getElementById('max-hp-display').textContent = newValue || 10;
            } else {
                const overrideInput = document.getElementById(`${statId}-override`);
                if (newValue === '') { overrideInput.value = ''; updateCombatStats(); }
                else { overrideInput.value = newValue; document.getElementById(statId).textContent = newValue; }
            }
        }

        function makeEditable(displayElement, inputId) {
            const input = document.getElementById(inputId);
            displayElement.innerHTML = `<input type="number" value="${input.value}" min="1" max="30" style="width: 100%; border: none; text-align: center; font-size: 24px; font-weight: bold; background: transparent; outline: none;" onblur="finishEdit('${inputId}')" onkeypress="if(event.key==='Enter') this.blur();" id="${inputId}-temp">`;
            const tempInput = document.getElementById(`${inputId}-temp`);
            tempInput.focus(); tempInput.select();
        }

        function finishEdit(inputId) {
            const tempInput = document.getElementById(`${inputId}-temp`);
            document.getElementById(inputId).value = tempInput.value;
            document.getElementById(`${inputId}-display`).textContent = tempInput.value;
            updateModifiers();
        }

        function setExhaustion(level) {
            currentExhaustion = level;
            document.getElementById('exhaustion-level').textContent = level;
            document.querySelectorAll('.exhaustion-box').forEach((box, index) => { box.classList.toggle('filled', index < level); });
        }

        function calculateModifier(score) { return Math.floor((score - 10) / 2); }
        function getProficiencyBonus(level) { return Math.ceil(level / 4) + 1; }

        function updateModifiers() {
            ['str', 'dex', 'con', 'int', 'wis', 'cha'].forEach(ability => {
                const score = parseInt(document.getElementById(ability).value) || 10;
                const modifier = calculateModifier(score);
                document.getElementById(`${ability}-mod`).textContent = modifier >= 0 ? `+${modifier}` : `${modifier}`;
            });
            updateCombatStats(); updateSaves(); updateSkills();
        }

        function updateCombatStats() {
            const dexMod = calculateModifier(parseInt(document.getElementById('dex').value) || 10);
            if (!document.getElementById('initiative-override').value) document.getElementById('initiative').textContent = dexMod >= 0 ? `+${dexMod}` : `${dexMod}`;
            if (!document.getElementById('ac-override').value) document.getElementById('ac').textContent = 10 + dexMod;
            if (!document.getElementById('speed-override').value) document.getElementById('speed').textContent = '30';
            updatePassivePerception();
        }

        function updatePassivePerception() {
            if (!document.getElementById('passive-perception-override').value) {
                const profBonus = getProficiencyBonus(parseInt(document.getElementById('level').value) || 1);
                const wisMod = calculateModifier(parseInt(document.getElementById('wis').value) || 10);
                const perceptionCheckbox = document.querySelector('input[data-skill="11"]');
                const isProficient = perceptionCheckbox ? perceptionCheckbox.checked : false;
                document.getElementById('passive-perception').textContent = 10 + wisMod + (isProficient ? profBonus : 0);
            }
        }

        function updateHitDiceMax() {
            const level = parseInt(document.getElementById('level').value) || 1;
            document.getElementById('max-hit-dice').textContent = level;
            const current = parseInt(document.getElementById('current-hit-dice').textContent);
            if (current > level) document.getElementById('current-hit-dice').textContent = level;
        }

        function spendHitDice() {
            const el = document.getElementById('current-hit-dice');
            let current = parseInt(el.textContent);
            if (current > 0) el.textContent = current - 1;
        }

        function restoreHitDice() {
            const el = document.getElementById('current-hit-dice');
            const max = parseInt(document.getElementById('max-hit-dice').textContent);
            let current = parseInt(el.textContent);
            if (current < max) el.textContent = current + 1;
        }

        function updateProficiencyBonus() {
            const level = parseInt(document.getElementById('level').value) || 1;
            document.getElementById('prof-bonus').textContent = `+${getProficiencyBonus(level)}`;
            updateHitDiceMax(); 
            updateSaves(); 
            updateSkills();
            updateSpellSlots(); // Update spell slots when level changes
        }

        function updateSaves() {
            const profBonus = getProficiencyBonus(parseInt(document.getElementById('level').value) || 1);
            ['str', 'dex', 'con', 'int', 'wis', 'cha'].forEach(ability => {
                const modifier = calculateModifier(parseInt(document.getElementById(ability).value) || 10);
                const isProficient = document.querySelector(`input[data-save="${ability}"]`).checked;
                const total = modifier + (isProficient ? profBonus : 0);
                document.getElementById(`save-${ability}`).textContent = total >= 0 ? `+${total}` : `${total}`;
            });
        }

        function updateSkills() {
            const profBonus = getProficiencyBonus(parseInt(document.getElementById('level').value) || 1);
            skills.forEach((skill, index) => {
                const modifier = calculateModifier(parseInt(document.getElementById(skill.ability).value) || 10);
                const checkbox = document.querySelector(`input[data-skill="${index}"]`);
                if (checkbox) {
                    const total = modifier + (checkbox.checked ? profBonus : 0);
                    const bonusElement = document.getElementById(`skill-${index}`);
                    if (bonusElement) bonusElement.textContent = total >= 0 ? `+${total}` : `${total}`;
                }
            });
            updatePassivePerception();
        }

        // ═══════════════════════════════════════════════════════════════════
        //  Export / Import
        // ═══════════════════════════════════════════════════════════════════
        function exportCharacter() {
            saveCharacter(true); // save first
            const data = localStorage.getItem('dndCharacter');
            if (!data) { alert('No character to export.'); return; }
            const char = JSON.parse(data);
            const filename = (char.name || 'character').replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.json';
            const blob = new Blob([data], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function importCharacter(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.name && !data.class) { alert('This doesn\'t look like a valid character file.'); return; }
                    localStorage.setItem('dndCharacter', JSON.stringify(data));
                    loadCharacter();
                    alert(`Imported ${data.name || 'character'} successfully!`);
                } catch (err) {
                    alert('Error reading file: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // reset file input
        }

        // ═══════════════════════════════════════════════════════════════════
        //  Save / Load
        // ═══════════════════════════════════════════════════════════════════
        function saveCharacter(silent) {
            const character = {
                name: document.getElementById('charName').value,
                species: document.getElementById('species').value,
                class: document.getElementById('class').value,
                subclass: document.getElementById('subclass').value,
                background: document.getElementById('background').value,
                alignment: document.getElementById('alignment').value,
                level: document.getElementById('level').value,
                xp: document.getElementById('xp').value,
                size: document.getElementById('size').value,
                abilities: {
                    str: document.getElementById('str').value, dex: document.getElementById('dex').value,
                    con: document.getElementById('con').value, int: document.getElementById('int').value,
                    wis: document.getElementById('wis').value, cha: document.getElementById('cha').value
                },
                combat: {
                    currentHP: document.getElementById('current-hp').value,
                    maxHP: document.getElementById('max-hp').value,
                    tempHP: document.getElementById('temp-hp').value,
                    hitDiceType: document.getElementById('hit-dice-type').value,
                    currentHitDice: document.getElementById('current-hit-dice').textContent,
                    exhaustion: currentExhaustion,
                    inspiration: document.getElementById('inspiration').checked,
                    acOverride: document.getElementById('ac-override').value,
                    initiativeOverride: document.getElementById('initiative-override').value,
                    speedOverride: document.getElementById('speed-override').value,
                    passivePerceptionOverride: document.getElementById('passive-perception-override').value
                },
                deathSaves: {
                    successes: Array.from(document.querySelectorAll('input[data-type="success"]')).map(cb => cb.checked),
                    failures: Array.from(document.querySelectorAll('input[data-type="failure"]')).map(cb => cb.checked)
                },
                proficiencies: {
                    saves: Array.from(document.querySelectorAll('input[data-save]')).map(cb => ({ ability: cb.dataset.save, proficient: cb.checked })),
                    skills: Array.from(document.querySelectorAll('input[data-skill]')).map(cb => ({ index: cb.dataset.skill, proficient: cb.checked })),
                    armor: {
                        light: document.getElementById('prof-light-armor').checked,
                        medium: document.getElementById('prof-medium-armor').checked,
                        heavy: document.getElementById('prof-heavy-armor').checked,
                        shields: document.getElementById('prof-shields').checked
                    },
                    weapons: document.getElementById('weapon-profs').value,
                    tools: document.getElementById('tool-profs').value,
                    languages: document.getElementById('languages').value
                },
                coins: {
                    cp: document.getElementById('coin-cp').value, sp: document.getElementById('coin-sp').value,
                    ep: document.getElementById('coin-ep').value, gp: document.getElementById('coin-gp').value,
                    pp: document.getElementById('coin-pp').value
                },
                conditions: Array.from(document.querySelectorAll('.condition-check')).map(cb => ({ condition: cb.dataset.condition, active: cb.checked })),
                notes: document.getElementById('notes').value,
                spells: {
                    knownSpells: window.currentSpells.knownSpells,
                    preparedSpells: window.currentSpells.preparedSpells,
                    spellSlots: window.currentSpells.spellSlots
                }
            };
            localStorage.setItem('dndCharacter', JSON.stringify(character));
            if (!silent) alert('Character saved!');
        }

        function loadCharacter() {
            const saved = localStorage.getItem('dndCharacter');
            if (!saved) return;
            const character = JSON.parse(saved);

            document.getElementById('charName').value = character.name || '';
            document.getElementById('species').value = character.species || character.race || '';
            document.getElementById('class').value = character.class || '';
            document.getElementById('subclass').value = character.subclass || '';
            document.getElementById('background').value = character.background || '';
            document.getElementById('alignment').value = character.alignment || '';
            document.getElementById('level').value = character.level || 1;
            document.getElementById('xp').value = character.xp || 0;
            document.getElementById('size').value = character.size || 'Medium';

            Object.keys(character.abilities).forEach(ability => {
                document.getElementById(ability).value = character.abilities[ability];
                document.getElementById(`${ability}-display`).textContent = character.abilities[ability];
            });

            document.getElementById('current-hp').value = character.combat.currentHP || character.combat.hp || 10;
            const maxHP = character.combat.maxHP || character.combat.hp || 10;
            document.getElementById('max-hp').value = maxHP;
            document.getElementById('max-hp-display').textContent = maxHP;
            document.getElementById('temp-hp').value = character.combat.tempHP || 0;
            document.getElementById('hit-dice-type').value = character.combat.hitDiceType || character.combat.hitDice || '1d8';
            document.getElementById('current-hit-dice').textContent = character.combat.currentHitDice || character.level || 1;
            document.getElementById('inspiration').checked = character.combat.inspiration || false;
            if (character.combat.inspiration) toggleInspiration();

            if (character.combat.acOverride) { document.getElementById('ac-override').value = character.combat.acOverride; document.getElementById('ac').textContent = character.combat.acOverride; }
            if (character.combat.initiativeOverride) { document.getElementById('initiative-override').value = character.combat.initiativeOverride; document.getElementById('initiative').textContent = character.combat.initiativeOverride; }
            if (character.combat.speedOverride) { document.getElementById('speed-override').value = character.combat.speedOverride; document.getElementById('speed').textContent = character.combat.speedOverride; }
            if (character.combat.passivePerceptionOverride) { document.getElementById('passive-perception-override').value = character.combat.passivePerceptionOverride; document.getElementById('passive-perception').textContent = character.combat.passivePerceptionOverride; }

            if (character.combat.exhaustion > 0) toggleExhaustion(character.combat.exhaustion);

            if (character.deathSaves) {
                character.deathSaves.successes.forEach((checked, index) => { document.querySelector(`input[data-type="success"][data-index="${index}"]`).checked = checked; });
                character.deathSaves.failures.forEach((checked, index) => { document.querySelector(`input[data-type="failure"][data-index="${index}"]`).checked = checked; });
            }

            character.proficiencies.saves.forEach(save => { document.querySelector(`input[data-save="${save.ability}"]`).checked = save.proficient; });
            character.proficiencies.skills.forEach(skill => { document.querySelector(`input[data-skill="${skill.index}"]`).checked = skill.proficient; });

            if (character.proficiencies.armor) {
                document.getElementById('prof-light-armor').checked = character.proficiencies.armor.light || false;
                document.getElementById('prof-medium-armor').checked = character.proficiencies.armor.medium || false;
                document.getElementById('prof-heavy-armor').checked = character.proficiencies.armor.heavy || false;
                document.getElementById('prof-shields').checked = character.proficiencies.armor.shields || false;
            }
            if (character.proficiencies.weapons) document.getElementById('weapon-profs').value = character.proficiencies.weapons;
            if (character.proficiencies.tools) document.getElementById('tool-profs').value = character.proficiencies.tools;
            if (character.proficiencies.languages) document.getElementById('languages').value = character.proficiencies.languages;

            if (character.coins) {
                document.getElementById('coin-cp').value = character.coins.cp || 0;
                document.getElementById('coin-sp').value = character.coins.sp || 0;
                document.getElementById('coin-ep').value = character.coins.ep || 0;
                document.getElementById('coin-gp').value = character.coins.gp || 0;
                document.getElementById('coin-pp').value = character.coins.pp || 0;
            }

            if (character.conditions) {
                character.conditions.forEach(cond => {
                    const checkbox = document.querySelector(`.condition-check[data-condition="${cond.condition}"]`);
                    if (checkbox) checkbox.checked = cond.active;
                });
            }

            if (character.notes) document.getElementById('notes').value = character.notes;

            // Load spells
            if (character.spells) {
                window.currentSpells.knownSpells = character.spells.knownSpells || [];
                window.currentSpells.preparedSpells = character.spells.preparedSpells || [];
                window.currentSpells.spellSlots = character.spells.spellSlots || window.currentSpells.spellSlots;
            }

            updateModifiers();
            updateProficiencyBonus();
        }

        // Event listeners
        document.getElementById('level').addEventListener('input', updateProficiencyBonus);
        document.getElementById('class').addEventListener('input', updateSpellSlots);

        // ═══════════════════════════════════════════════════════════════════
        //  SPELL BROWSER MODAL FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════

        function openSpellBrowser() {
            document.getElementById('spell-browser-modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            renderModalSpells();
        }

        function closeSpellBrowser() {
            document.getElementById('spell-browser-modal').style.display = 'none';
            document.body.style.overflow = '';
            renderSpellbook();
        }

        function renderModalSpells() {
            const container = document.getElementById('modal-spell-list');
            if (!container) return;
            
            // Check if SPELLS database is loaded
            if (typeof SPELLS === 'undefined' || !SPELLS || SPELLS.length === 0) {
                container.innerHTML = '<p style="color: #d9534f; text-align: center; padding: 40px;"><strong>Error:</strong> Spell database not loaded. Make sure <code>js/data/spells.js</code> is uploaded and the script tag is in your HTML head.</p>';
                return;
            }
            
            const searchTerm = (document.getElementById('modal-spell-search')?.value || '').toLowerCase();
            const classFilter = document.getElementById('modal-class-filter')?.value || '';
            const levelFilter = document.getElementById('modal-level-filter')?.value || '';
            const schoolFilter = document.getElementById('modal-school-filter')?.value || '';
            
            let filteredSpells = SPELLS.filter(spell => {
                const alreadyKnown = window.currentSpells.knownSpells.some(s => s.name === spell.name);
                if (alreadyKnown) return false;
                
                if (searchTerm && !spell.name.toLowerCase().includes(searchTerm) && 
                    !(spell.desc || '').toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                if (classFilter && !spell.classes.includes(classFilter)) {
                    return false;
                }
                
                if (levelFilter !== '' && spell.level !== parseInt(levelFilter)) {
                    return false;
                }
                
                if (schoolFilter && spell.school !== schoolFilter) {
                    return false;
                }
                
                return true;
            });
            
            const byLevel = {};
            for (let i = 0; i <= 9; i++) byLevel[i] = [];
            
            filteredSpells.forEach(spell => {
                if (spell.level >= 0 && spell.level <= 9) {
                    byLevel[spell.level].push(spell);
                }
            });
            
            let html = '';
            
            for (let level = 0; level <= 9; level++) {
                const spells = byLevel[level];
                if (spells.length === 0) continue;
                
                const levelName = level === 0 ? 'Cantrips' : `Level ${level}`;
                
                html += `<div style="margin-bottom: 20px;">
                    <h4 style="font-family: var(--font-heading); font-size: 14px; color: var(--brown-dark); margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid var(--brown-light);">${levelName}</h4>`;
                
                spells.forEach(spell => {
                    html += `
                        <div style="background: linear-gradient(135deg, #fff9f0, #f5ede0); border: 2px solid var(--brown-light); border-radius: 6px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-family: var(--font-heading); font-size: 13px; font-weight: 700; color: var(--brown-dark); margin-bottom: 2px;">${spell.name}</div>
                                <div style="font-size: 11px; color: #666;">
                                    <span style="font-style: italic;">${spell.school}</span> • 
                                    <span>${spell.classes.join(', ')}</span> • 
                                    <span style="color: var(--brown-primary); font-weight: 600;">${spell.source}</span>
                                </div>
                            </div>
                            <button onclick="addSpellToSpellbook('${spell.name.replace(/'/g, "\\\'")}')" style="padding: 6px 14px; background: linear-gradient(135deg, var(--green-primary), var(--green-dark)); color: white; border: none; border-radius: 4px; font-family: var(--font-heading); font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap;">+ Add</button>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            if (!html) {
                html = '<p style="color: #999; font-style: italic; text-align: center; padding: 40px;">No spells found matching your filters.</p>';
            }
            
            container.innerHTML = html;
        }

        function filterModalSpells() {
            renderModalSpells();
        }

        function addSpellToSpellbook(spellName) {
            const spell = SPELLS.find(s => s.name === spellName);
            if (!spell) return;
            
            if (window.currentSpells.knownSpells.some(s => s.name === spellName)) {
                return;
            }
            
            window.currentSpells.knownSpells.push(spell);
            
            if (spell.level === 0 && !window.currentSpells.preparedSpells.includes(spellName)) {
                window.currentSpells.preparedSpells.push(spellName);
            }
            
            renderModalSpells();
            saveCharacter(true);
        }

        function removeSpellFromSpellbook(spellName) {
            if (!confirm(`Remove ${spellName} from your spellbook?`)) return;
            
            window.currentSpells.knownSpells = window.currentSpells.knownSpells.filter(s => s.name !== spellName);
            
            const prepIndex = window.currentSpells.preparedSpells.indexOf(spellName);
            if (prepIndex > -1) {
                window.currentSpells.preparedSpells.splice(prepIndex, 1);
            }
            
            renderSpellbook();
            saveCharacter(true);
        }

        // Initialize
        updateModifiers();
        updateProficiencyBonus();
        loadCharacter();
    </script>
    <!-- Level-Up Modal -->
<div class="levelup-overlay hidden" id="levelup-overlay">
    <div class="levelup-modal">
        <div class="levelup-header">
            <div class="levelup-title">Level Up</div>
            <div class="levelup-subtitle" id="levelup-subtitle">Advancing to Level X</div>
        </div>

        <!-- Step 1: HP -->
        <div class="levelup-step active" id="step-hp">
            <div class="step-section">
                <div class="step-label">Hit Points</div>
                <div class="step-description">Choose how to determine your new maximum HP.</div>
                <div class="hp-options" id="levelup-hp-options"></div>
            </div>
        </div>

        <!-- Step 2: ASI/Feat -->
        <div class="levelup-step" id="step-asi">
            <div class="step-section">
                <div class="step-label">Ability Score Improvement</div>
                <div class="step-description">You can increase ability scores or take a feat.</div>
                <div class="asi-options" id="asi-type-options"></div>
                <div class="asi-selectors" id="asi-selectors"></div>
            </div>
        </div>

        <!-- Step 3: New Features -->
        <div class="levelup-step" id="step-features">
            <div class="step-section">
                <div class="step-label">New Features</div>
                <div class="step-description">You gain the following class features at this level.</div>
                <div class="features-list" id="features-content"></div>
            </div>
        </div>

        <!-- Step 4: Summary -->
        <div class="levelup-step" id="step-summary">
            <div class="step-section">
                <div class="step-label">Summary</div>
                <div class="step-description">Review your level-up changes.</div>
                <div class="levelup-summary" id="levelup-summary-content"></div>
            </div>
        </div>

        <!-- Buttons -->
        <div class="levelup-buttons">
            <button class="levelup-btn levelup-btn-cancel" onclick="closeLevelUpModal()">Cancel</button>
            <button class="levelup-btn levelup-btn-back" id="levelup-btn-back" onclick="prevLevelUpStep()">Back</button>
            <button class="levelup-btn levelup-btn-next" id="levelup-btn-next" onclick="nextLevelUpStep()">Continue</button>
            <button class="levelup-btn levelup-btn-finish" id="levelup-btn-finish" onclick="finishLevelUp()" style="display:none">Level Up!</button>
        </div>
    </div>
</div>
    <script src="js/data/class-features.js"></script>
<script src="js/level-up.js"></script>
</body>
</html>
